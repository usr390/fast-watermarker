{% extends "base.html" %}
{% block title %}Upload | Fast Watermarker{% endblock %}

{% block content %}
<!-- Upload navbar (logo + hamburger + profile) -->
<nav class="navbar navbar-expand-lg navbar-dark bg-transparent mb-4">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="/">
      <img src="{{ url_for('static', path='images/logo.png') }}" alt="FastWatermarker" height="120" />
      <i><span class="brand-pro">Pro</span></i>
    </a>
  </div>
</nav>
<!-- <nav class="navbar navbar-expand-lg navbar-dark bg-transparent mb-4">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="/">
      <img src="{{ url_for('static', path='images/logo.png') }}" alt="FastWatermarker" height="120" />
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#fwNavUpload" aria-controls="fwNavUpload"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse pt-2 pb-3" id="fwNavUpload">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/#features">Features</a></li>
        <li class="nav-item"><a class="nav-link" href="/#how">How it works</a></li>
        <li class="nav-item"><a class="nav-link" href="/#pricing">Pricing</a></li>
        <li class="nav-item"><a class="nav-link" href="/#testimonials">Reviews</a></li>
        <li class="nav-item"><a class="nav-link" href="/#faq">FAQ</a></li>
      </ul>

      <div class="ms-lg-3 mt-3 mt-lg-0 d-flex gap-2 align-items-center mb-2 mb-lg-0">
        <div id="clerk-user-button-upload" style="display:none"></div>
        <a id="clerk-signin-link-upload" class="btn btn-outline-light" href="/login">Sign in</a>
        <a class="btn btn-primary d-none d-lg-inline-block disabled" tabindex="-1" aria-disabled="true">Start watermarking</a>
      </div>
    </div>
  </div>
</nav> -->

  <form id="wmForm" action="/upload-multi" method="post" enctype="multipart/form-data" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label d-flex align-items-center justify-content-between">
        <span>Media file(s)</span>
      </label>
      <input id="fileInput" class="visually-hidden" type="file" name="files"
            accept="image/*,video/*" multiple required>
      <div id="dropZone" class="dropzone" role="button" tabindex="0">
        <div class="dz-icon">+</div>
        <div class="dz-title">Drag & drop images or videos</div>
      </div>
      <i><small id="nonProNoticeUploads"
            class="d-none ai-logo-cta d-block text-nowrap mt-2">
        Upload multiple files with <a href="/pricing" class="linklike">FastWatermarker Pro</a>.
      </small></i>
      <div id="previewContainer" class="row row-cols-2 row-cols-md-3 g-2 mt-2"></div>
      <div id="statusErrorFiles" class="alert alert-danger d-none mt-3 mb-0" role="alert" aria-live="assertive"></div>
    </div>

    <hr class="my-4">

    <div class="mb-3">
      <label class="form-label">Logo watermark</label>
      <input id="logoInput" class="visually-hidden" type="file" name="logo" accept="image/svg+xml,image/png,image/*">
      <div id="logoDropZone" class="dropzone dropzone--small" role="button" tabindex="0" aria-label="Drop a logo or click to browse">
        <div class="dz-icon">+</div>
        <div class="dz-title">Upload a logo</div>
      </div>

      <p class="ai-logo-cta d-flex align-items-center justify-content-between">
        <button type="button" class="linklike d-inline-flex align-items-center gap-1" id="aiLogoOpenBtn">
          <i class="bi bi-stars"></i>
          Don't have one yet? Generate One!
        </button>
      </p>

      <div id="logoPreviewContainer" class="mt-2"></div>
    </div>

    <div class="d-flex justify-content-center align-items-center my-3">
      <span class="text-muted">OR</span>
    </div>

    <div class="mb-3">
      <label class="form-label">Text watermark</label>
      <input id="wmText" class="form-control" type="text" name="text" placeholder="Â© mybrand">
      <small id="wmReqMsg" class="text-danger d-none">Add a logo or enter text to continue.</small>
    </div>

    <hr class="my-4">

    <div class="mb-3">
      <label for="scaleInput" class="form-label d-flex align-items-center justify-content-between">
        <span>Watermark size</span>
        <span id="scaleValue" class="text-muted" aria-live="polite">Medium</span>
      </label>

      <input class="form-range"
            type="range"
            min="0.20" max="0.80" step="0.05"
            name="scale" id="scaleInput" value="0.60">
    </div>

    <div class="mb-3">
      <label for="opacityInput" class="form-label d-flex align-items-center justify-content-between">
        <span>Watermark opacity</span>
        <span id="opacityValue" class="text-muted opacity-value" aria-live="polite">0.90</span>
      </label>
      <input class="form-range" type="range"
            min="0" max="1" step="0.05"
            name="opacity" id="opacityInput" value="0.90">
    </div>

    <div class="mb-3">
      <label class="form-label d-flex align-items-center justify-content-between">
        <span>Watermark position</span>
        <span id="positionValue" class="text-muted position-value" aria-live="polite">center</span>
      </label>

      <input type="hidden" name="position" id="positionInput" value="center">

      <div class="pos-grid" role="group" aria-label="Watermark position">
        <button type="button" class="pos-cell" data-pos="tl" aria-label="Top left"></button>
        <button type="button" class="pos-cell pos-disabled"></button>
        <button type="button" class="pos-cell" data-pos="tr" aria-label="Top right"></button>

        <button type="button" class="pos-cell pos-disabled"></button>
        <button type="button" class="pos-cell active" data-pos="center" aria-label="Center"></button>
        <button type="button" class="pos-cell pos-disabled"></button>

        <button type="button" class="pos-cell" data-pos="bl" aria-label="Bottom left"></button>
        <button type="button" class="pos-cell pos-disabled"></button>
        <button type="button" class="pos-cell" data-pos="br" aria-label="Bottom right"></button>
      </div>

      <hr class="my-4">
    </div>

    <button id="submitBtn" class="btn btn-primary" type="submit">Upload</button>

    <div id="statusLoading" class="alert alert-info d-none mt-3 mb-0">
      <div class="d-flex align-items-center gap-2">
        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        <span>Processing your files...</span>
      </div>
    </div>
    <div id="statusSuccess" class="alert alert-success d-none mt-3 mb-0">
      Done! <strong id="outName">watermarked.zip</strong>
      <a id="downloadLink" class="ms-2" style="color: green" download>Download</a>
    </div>
    <div id="statusErrorGlobal" class="alert alert-danger d-none mt-3 mb-0" role="alert" aria-live="assertive"></div>
    <div id="inlineResult" class="mt-3 d-none">
      <figure class="m-0">
        <img id="resultImg" class="img-fluid rounded shadow-sm d-none" alt="Watermarked result" />
        <video id="resultVideo" class="w-100 rounded shadow-sm d-none" playsinline controls></video>
        <figcaption class="small text-muted mt-2">
          Long-press the image to save to Photos. 
          <a id="openInNewTab" class="ms-2 d-none" target="_blank" rel="noopener">Open in new tab</a>
          <a id="downloadInline" class="ms-2 d-none" download>Download</a>  <!-- NEW -->
        </figcaption>
      </figure>
    </div>
  </form>

  <div class="ai-modal-backdrop" id="aiLogoModal" hidden aria-hidden="true">
    <div class="ai-modal" role="dialog" aria-modal="true" aria-labelledby="aiLogoTitle">
      <header class="ai-modal-header">
        <h3 id="aiLogoTitle">FastWatermarker AI</h3>
        <button type="button" class="ai-iconbtn" id="aiLogoCloseBtn" aria-label="Close">âœ•</button>
      </header>

      <form id="aiLogoForm" class="ai-modal-body" role="form">
        <label class="field">
          <span>Logo text</span>
          <input name="text" type="text" placeholder="e.g., mybrand" required />
        </label>

        <label class="field">
          <span>Colors</span>
          <input name="colors" type="text" placeholder="e.g., red, white, black" />
          <small>Comma-separated. You can paste hex codes too.</small>
        </label>

        <label class="field">
          <span>Style</span>
          <input name="style" type="text" placeholder="e.g., modern minimal badge, hand-drawn vibe" />
          <small>Describe the look you want (keywords, phrases, anything).</small>
        </label>

        <div class="ai-actions">
          <button type="button" id="aiLogoPreviewBtn" class="btn" >
            <span class="btn-label">Generate preview</span>
            <span class="btn-spinner" aria-hidden="true"></span>
          </button>          
          <button type="button" id="aiLogoUseBtn" disabled>Use this</button>
          <button type="button" id="aiLogoDownloadBtn" disabled>Download</button>
        </div>

        <div class="ai-preview" id="aiLogoPreview" aria-live="polite">
          <div class="ai-preview-card" id="aiLogoPreviewCard">
            <img id="aiLogoPreviewImg" alt="AI preview" style="max-width:100%;display:none"/>
            <div id="aiLogoPlaceholder" class="ai-placeholder" aria-hidden="true">
              Image Preview Here
            </div>
          </div>
        </div>
        
      </form>
    </div>
  </div>
  <!-- Pro Upsell (custom modal, same system as AI modal) -->
  <div class="ai-modal-backdrop" id="upsellModal" hidden aria-hidden="true">
    <div class="ai-modal" role="dialog" aria-modal="true" aria-labelledby="upsellTitle">
      <header class="ai-modal-header">
        <h3 id="upsellTitle">Woah! You discovered a Pro feature</h3>
        <button type="button" class="ai-iconbtn" id="upsellXBtn" aria-label="Close">âœ•</button>
      </header>

      <div class="ai-modal-body">
        Unlock AI logo generation and more with FastWatermarker Pro.
      </div>

      <div class="ai-actions" style="gap:.5rem">
        <a href="/pricing" class="btn btn-primary" id="upsellGoPricing">See plans</a>
        <button type="button" class="btn btn-outline-secondary" id="upsellCloseBtn">Maybe later</button>
      </div>
    </div>
  </div>

  <style>
    .remove-btn { position: absolute; top: 5px; right: 5px; background: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; padding: 0; }
    .remove-btn:hover { background: rgba(255, 0, 0, 0.8); }
    .preview-wrapper { position: relative; }
  </style>
  <style>
  /* uses your brand yellow; falls back to #FFC107 if not set */
  .brand-pro{
    color: #ffcc00;
    font-weight: 600;
    font-size: 1.25rem; /* tweak to taste */
    line-height: 1;
  }
</style>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (!window.Clerk) return;
      await window.Clerk.load();

      const mount = () => {
        const userBtn = document.getElementById('clerk-user-button-upload');
        const signIn = document.getElementById('clerk-signin-link-upload');

        if (window.Clerk.isSignedIn) {
          signIn && (signIn.style.display = 'none');
          if (userBtn) {
            userBtn.style.display = '';
            window.Clerk.mountUserButton(userBtn, {
              appearance: {
                elements: {
                  userButtonPopoverCard: 'shadow-lg',
                }
              }
            });
          }
        } else {
          userBtn && (userBtn.innerHTML = '');
          signIn && (signIn.style.display = '');
        }
      };

      mount();
      // Re-apply when auth state changes (e.g., after login)
      window.Clerk?.addListener?.(mount);
    });
  </script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // ðŸ”’ Recruiter demo: always behave like Pro (AI modal always opens, multi-upload enabled)
  const FORCE_PRO = true;

  // -----------------------------
  // Grab elements
  // -----------------------------
  const aiBtn = document.getElementById('aiLogoOpenBtn');
  const aiModal = document.getElementById('aiLogoModal');
  const aiCloseBtn = document.getElementById('aiLogoCloseBtn');

  const upsell = document.getElementById('upsellModal'); // we'll effectively disable this
  const upsellXBtn = document.getElementById('upsellXBtn');
  const upsellCloseBtn = document.getElementById('upsellCloseBtn');
  const upsellGoPricing = document.getElementById('upsellGoPricing');

  const fileInput = document.getElementById('fileInput');
  const dropTitle = document.querySelector('#dropZone .dz-title');
  const nonProUploads = document.getElementById('nonProNoticeUploads');

  // -----------------------------
  // Helpers
  // -----------------------------
  function openOverlay(el) {
    if (!el) return;
    el.hidden = false;
    el.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }
  function closeOverlay(el, focusEl) {
    if (!el) return;
    el.hidden = true;
    el.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    focusEl?.focus?.();
  }

  function openAIModal() {
    openOverlay(aiModal);
    aiModal?.querySelector('#aiLogoForm [name="text"]')?.focus();
  }
  function closeAIModal() { closeOverlay(aiModal, aiBtn); }
  aiCloseBtn?.addEventListener('click', closeAIModal);
  aiModal?.addEventListener('click', (e) => { if (e.target === aiModal) closeAIModal(); });

  // Disable upsell entirely when forcing pro
  function openUpsell(){ if (FORCE_PRO) return openAIModal(); openOverlay(upsell); }
  function closeUpsell(){ closeOverlay(upsell, aiBtn); }
  upsellXBtn?.addEventListener('click', closeUpsell);
  upsellCloseBtn?.addEventListener('click', closeUpsell);
  upsell?.addEventListener('click', (e) => { if (e.target === upsell) closeUpsell(); });
  upsellGoPricing?.addEventListener('click', () => closeUpsell());

  window.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    if (!aiModal?.hidden) return closeAIModal();
    if (!upsell?.hidden) return closeUpsell();
  });

  // -----------------------------
  // Pro check (short-circuited)
  // -----------------------------
  async function getProStatus(){
    if (FORCE_PRO) return true;                     // ðŸ‘ˆ key line
    try {
      if (!window.Clerk) return false;
      await window.Clerk.load();
      const session = window.Clerk.session;
      if (!window.Clerk.isSignedIn || !session) return false;
      const res = session.checkAuthorization?.({ plan: 'fastwatermarker_pro' });
      const authorized = typeof res === 'boolean' ? res : await res;
      return !!authorized;
    } catch { return false; }
  }

  // -----------------------------
  // Apply gating (respects FORCE_PRO)
  // -----------------------------
  function applyUploadGating(isPro){
    const form = document.getElementById('wmForm');
    if (!isPro) {
      // (won't run with FORCE_PRO = true)
      dropTitle && (dropTitle.textContent = 'Upload an image or video');
      fileInput?.removeAttribute('multiple');
      nonProUploads?.classList.remove('d-none');
      aiBtn && (aiBtn.innerHTML = '<i class="bi bi-stars"></i> Don\'t have one yet? Generate one!');
      form && (form.action = '/upload');
    } else {
      // Pro behavior
      dropTitle && (dropTitle.textContent = 'Drag & drop images or videos');
      fileInput?.setAttribute('multiple', '');
      nonProUploads?.classList.add('d-none');
      aiBtn && (aiBtn.innerHTML = '<i class="bi bi-stars"></i> Don\'t have one yet? Generate one!');
      form && (form.action = '/upload-multi');
    }
  }

  function wireAiButton(isPro){
    if (!aiBtn) return;
    const fresh = aiBtn.cloneNode(true);
    aiBtn.replaceWith(fresh);
    fresh.addEventListener('click', (e) => {
      e.preventDefault();
      // With FORCE_PRO, always open AI modal
      if (FORCE_PRO || isPro) return openAIModal();
      openUpsell();
    });
  }

  // -----------------------------
  // Init
  // -----------------------------
  const isPro = await getProStatus();               // will be true when FORCE_PRO = true
  applyUploadGating(isPro);
  wireAiButton(isPro);

  // If auth state changes, keep forcing pro behavior
  window.Clerk?.addListener?.(async () => {
    const pro = await getProStatus();
    applyUploadGating(pro);
    wireAiButton(pro);
  });
});
</script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== existing vars you already have =====
      let cachedLogoBlob = null;
      let cachedObjectURL = null;

      const previewBtnAI = document.getElementById('aiLogoPreviewBtn');
      const previewLabel = previewBtnAI?.querySelector('.btn-label');
      const useBtn       = document.getElementById('aiLogoUseBtn');
      const downloadBtn  = document.getElementById('aiLogoDownloadBtn');   // NEW
      const previewImg   = document.getElementById('aiLogoPreviewImg');
      const placeholder  = document.getElementById('aiLogoPlaceholder');
      const previewWrap  = document.getElementById('aiLogoPreview');
      const previewCard  = document.getElementById('aiLogoPreviewCard');

      // also need these for "Use this"
      const logoInput    = document.getElementById('logoInput');
      const modal        = document.getElementById('aiLogoModal');
      const openBtn      = document.getElementById('aiLogoOpenBtn');

      const oldLabel     = 'Generate preview';
      const loadingLabel = 'Generating previewâ€¦';
      const MOCK_MODE    = false;

      function getAIField(name){ return document.querySelector(`#aiLogoForm [name="${name}"]`); }
      function readAIInputs(){
        const fd = new FormData(document.getElementById('aiLogoForm'));
        return {
          text  : (fd.get('text')   || '').toString().trim(),
          colors: (fd.get('colors') || '').toString().trim(),
          style : (fd.get('style')  || '').toString().trim(),
        };
      }
      async function generateLogo({ text, colors, style }) {
        if (MOCK_MODE) {
          await new Promise(r=>setTimeout(r,1200));
          const dummy = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO0Afd0AAAAASUVORK5CYII=";
          return await (await fetch(dummy)).blob();
        }
        const res = await fetch('/api/generate-logo', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(readAIInputs()),
        });
        if (!res.ok) throw new Error(await res.text().catch(()=> 'Failed to generate'));
        return res.blob();
      }
      function closeModal() {
        if (!modal) return;
        modal.hidden = true;
        modal.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        openBtn?.focus();
      }

      // ===== Generate preview =====
      previewBtnAI?.addEventListener('click', async () => {
        const { text } = readAIInputs();
        if (!text) {
          useBtn && (useBtn.disabled = true);
          downloadBtn && (downloadBtn.disabled = true);
          getAIField('text')?.focus();
          return;
        }

        previewBtnAI.disabled = true;
        previewBtnAI.classList.add('btn-loading');
        if (previewLabel) previewLabel.textContent = loadingLabel;
        useBtn && (useBtn.disabled = true);
        downloadBtn && (downloadBtn.disabled = true);

        previewCard?.classList.add('skeleton');
        previewWrap?.setAttribute('aria-busy','true');

        try {
          const blob = await generateLogo(readAIInputs());
          cachedLogoBlob = blob;

          // replace preview image
          if (cachedObjectURL) URL.revokeObjectURL(cachedObjectURL);
          cachedObjectURL = URL.createObjectURL(blob);
          if (previewImg) {
            // we'll revoke this URL on load; "Download" will make a fresh one
            previewImg.onload = () => { try { URL.revokeObjectURL(cachedObjectURL); } catch {} };
            previewImg.src = cachedObjectURL;
            previewImg.style.display = 'block';
          }
          placeholder && (placeholder.style.display = 'none');

          // enable actions
          useBtn && (useBtn.disabled = false);
          downloadBtn && (downloadBtn.disabled = false);
        } catch (e) {
          console.warn('Preview generation failed:', e);
          placeholder && (placeholder.style.display = '');
          previewImg && (previewImg.style.display = 'none');
          useBtn && (useBtn.disabled = true);
          downloadBtn && (downloadBtn.disabled = true);
        } finally {
          previewCard?.classList.remove('skeleton');
          previewWrap?.removeAttribute('aria-busy');
          previewBtnAI.disabled = false;
          previewBtnAI.classList.remove('btn-loading');
          if (previewLabel) previewLabel.textContent = oldLabel;
        }
      });

      // ===== Use this =====
      useBtn?.addEventListener('click', async () => {
        const payload = readAIInputs();
        if (!payload.text) return;

        useBtn.disabled = true;
        const old = useBtn.textContent;
        useBtn.textContent = 'Attachingâ€¦';
        try {
          let blob = cachedLogoBlob;
          if (!blob && !MOCK_MODE) {
            blob = await generateLogo(payload); // fallback generate
          }
          if (!blob) throw new Error('No preview to attach.');

          const file = new File([blob], 'ai-logo.png', { type: 'image/png' });
          const dt = new DataTransfer();
          dt.items.add(file);
          logoInput.files = dt.files;
          logoInput.dispatchEvent(new Event('change'));

          closeModal();
        } catch (e) {
          console.warn('Use failed:', e);
          // optionally surface a visible inline error element here
        } finally {
          useBtn.disabled = false;
          useBtn.textContent = old;
        }
      });

      // ===== Download =====
      downloadBtn?.addEventListener('click', () => {
        if (!cachedLogoBlob) return;
        const { text } = readAIInputs();
        const base = (text || 'ai-logo')
          .toLowerCase()
          .replace(/[^a-z0-9]+/g,'-')
          .replace(/^-+|-+$/g,'')
          .slice(0,50) || 'ai-logo';
        const url = URL.createObjectURL(cachedLogoBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${base}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 0);
      });

      // expose for debugging if you want
      window.__aiLogo = { get blob(){ return cachedLogoBlob; } };
    });
    </script>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  // ----- elements -----
  const fileInput   = document.getElementById('fileInput');
  const dropZone    = document.getElementById('dropZone');
  const previewWrap = document.getElementById('previewContainer');
  const logoInput   = document.getElementById('logoInput');
  const logoZone    = document.getElementById('logoDropZone');
  const logoWrap    = document.getElementById('logoPreviewContainer');
  const statusErr   = document.getElementById('statusErrorFiles') || document.getElementById('statusError');

  // limits
  const MAX_IMAGE_MB = 25;
  const MAX_VIDEO_MB = 300;

  // ----- helpers -----
  const showErr = (msg) => { if (!statusErr) return; statusErr.textContent = msg; statusErr.classList.remove('d-none'); };
  const hideErr = () => { statusErr?.classList.add('d-none'); };

  function addFilesToInput(fileList) {
    const dt = new DataTransfer();
    const existing = Array.from(fileInput.files || []);
    const incoming = Array.from(fileList || []);
    const combined = [...existing, ...incoming].slice(0, 20);
    combined.forEach(f => dt.items.add(f));
    fileInput.files = dt.files;
    fileInput.dispatchEvent(new Event('change'));
  }

  function renderMediaPreviews() {
    hideErr();
    previewWrap.innerHTML = '';
    const files = fileInput.files || [];
    if (files.length > 20) {
      showErr('You can only upload up to 20 files at once.');
      fileInput.value = '';
      return;
    }

    Array.from(files).forEach((f, index) => {
      const mb = f.size / (1024 * 1024);
      const isVideo = /^video\//.test(f.type);
      const limit = isVideo ? MAX_VIDEO_MB : MAX_IMAGE_MB;
      if (mb > limit) { showErr(`${f.name} exceeds ${limit} MB.`); return; }

      const col = document.createElement('div'); col.className = 'col';
      const card = document.createElement('div'); card.className = 'card h-100';
      const wrapper = document.createElement('div'); wrapper.className = 'preview-wrapper';

      const url = URL.createObjectURL(f);

      if (isVideo) {
        const shell = document.createElement('div'); shell.className = 'video-thumb';

        const img = document.createElement('img');
        img.className = 'thumb-img card-img-top';
        img.alt = f.name;
        shell.appendChild(img);

        const video = document.createElement('video');
        video.src = url; video.preload = 'metadata'; video.playsInline = true;
        video.setAttribute('playsinline',''); video.muted = true; video.controls = false;
        video.style.display = 'none'; video.className = 'card-img-top';
        shell.appendChild(video);

        const overlay = document.createElement('button');
        overlay.type = 'button'; overlay.className = 'play-overlay';
        overlay.innerHTML = `
          <svg viewBox="0 0 54 54" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <circle cx="27" cy="27" r="26" fill="rgba(0,0,0,.55)" stroke="white" stroke-width="2"/>
            <polygon points="22,17 22,37 38,27" fill="white"/>
          </svg>`;
        shell.appendChild(overlay);

        function drawThumb() {
          const w = video.videoWidth, h = video.videoHeight;
          if (!w || !h) return;
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d', { willReadFrequently: true });
          try { ctx.drawImage(video, 0, 0, w, h); img.src = canvas.toDataURL('image/jpeg', 0.72); } catch {}
        }
        function makeThumbAfterSeek() {
          if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
            video.requestVideoFrameCallback(() => { drawThumb(); });
          } else {
            const onSeeked = () => { video.removeEventListener('seeked', onSeeked); if (video.readyState >= 2) drawThumb(); else setTimeout(drawThumb, 50); };
            video.addEventListener('seeked', onSeeked);
          }
        }
        video.addEventListener('loadedmetadata', () => {
          const t = Math.min(0.1, (video.duration || 1) - 0.001);
          makeThumbAfterSeek();
          try { video.currentTime = t; } catch { setTimeout(() => { try { video.currentTime = t; } catch {} }, 30); }
        }, { once: true });

        overlay.addEventListener('click', () => {
          overlay.remove(); img.style.display = 'none';
          video.style.display = ''; video.controls = true; video.muted = false;
          video.play().catch(() => {});
        });

        wrapper.appendChild(shell);
        wrapper.addEventListener('DOMNodeRemoved', () => URL.revokeObjectURL(url), { once: true });
      } else {
        const img = document.createElement('img');
        img.alt = f.name; img.className = 'card-img-top';
        img.style.height = '140px'; img.style.objectFit = 'cover';
        img.src = url; img.onload = () => URL.revokeObjectURL(url);
        wrapper.appendChild(img);
      }

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn'; removeBtn.innerHTML = 'Ã—'; removeBtn.title = 'Remove file';
      removeBtn.addEventListener('click', () => {
        const dt = new DataTransfer();
        Array.from(fileInput.files).forEach((file, i) => { if (i !== index) dt.items.add(file); });
        fileInput.files = dt.files;
        fileInput.dispatchEvent(new Event('change'));
      });
      wrapper.appendChild(removeBtn);

      const cap = document.createElement('div');
      cap.className = 'card-body py-2';
      cap.innerHTML = `<small class="text-truncate d-block">${f.name}</small>`;

      card.appendChild(wrapper); card.appendChild(cap);
      col.appendChild(card);
      previewWrap.appendChild(col);
    });
  }

  function setLogoFile(file) {
    if (!file) return;
    if (!file.type.startsWith('image/')) { alert('Logo must be an image.'); return; }
    const mb = file.size / (1024*1024);
    if (mb > 25) { alert('Logo exceeds 25 MB.'); return; }

    const dt = new DataTransfer(); dt.items.add(file);
    logoInput.files = dt.files;

    // render preview
    logoWrap.innerHTML = '';
    const wrap = document.createElement('div'); wrap.className = 'preview-wrapper';
    const img = document.createElement('img');
    img.alt = 'Logo preview'; img.className = 'img-thumbnail mt-2'; img.style.maxHeight = '120px';
    const url = URL.createObjectURL(file); img.src = url;
    img.onload = () => URL.revokeObjectURL(url);

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn'; removeBtn.title = 'Remove logo'; removeBtn.innerHTML = 'Ã—';
    removeBtn.addEventListener('click', () => { logoInput.value = ''; logoWrap.innerHTML = ''; });

    wrap.appendChild(img); wrap.appendChild(removeBtn);
    logoWrap.appendChild(wrap);
  }

  // ----- WIRE: Media file(s) zone -----
  dropZone?.addEventListener('click', () => fileInput?.click());
  dropZone?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput?.click(); }
  });
  ['dragenter','dragover'].forEach(ev => dropZone?.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover');
  }));
  ['dragleave','dragend','drop'].forEach(ev => dropZone?.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover');
  }));
  dropZone?.addEventListener('drop', (e) => {
    const items = e.dataTransfer?.items;
    if (items && items.length) {
      const files = [];
      for (const it of items) { if (it.kind === 'file') { const f = it.getAsFile(); if (f) files.push(f); } }
      addFilesToInput(files);
    } else if (e.dataTransfer?.files?.length) {
      addFilesToInput(e.dataTransfer.files);
    }
  });
  dropZone?.addEventListener('paste', (e) => {
    const files = [];
    for (const it of e.clipboardData.items) { if (it.kind === 'file') { const f = it.getAsFile(); if (f) files.push(f); } }
    if (files.length) { e.preventDefault(); addFilesToInput(files); }
  });
  fileInput?.addEventListener('change', renderMediaPreviews);

  // ----- WIRE: Logo zone -----
  logoZone?.addEventListener('click', () => logoInput?.click());
  logoZone?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); logoInput?.click(); }
  });
  ['dragenter','dragover'].forEach(ev => logoZone?.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation(); logoZone.classList.add('dragover');
  }));
  ['dragleave','dragend','drop'].forEach(ev => logoZone?.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation(); logoZone.classList.remove('dragover');
  }));
  logoZone?.addEventListener('drop', (e) => {
    let file = null;
    const items = e.dataTransfer?.items;
    if (items && items.length) {
      for (const it of items) { if (it.kind === 'file') { const f = it.getAsFile(); if (f && f.type.startsWith('image/')) { file = f; break; } } }
    } else if (e.dataTransfer?.files?.length) {
      file = [...e.dataTransfer.files].find(f => f.type.startsWith('image/')) || null;
    }
    if (file) setLogoFile(file);
  });
  logoZone?.addEventListener('paste', (e) => {
    const item = [...e.clipboardData.items].find(it => it.kind === 'file');
    const file = item?.getAsFile();
    if (file && file.type.startsWith('image/')) { e.preventDefault(); setLogoFile(file); }
  });
  logoInput?.addEventListener('change', () => {
    // when "Use this" sets logoInput.files, keep preview in sync
    const f = logoInput.files?.[0];
    if (f) setLogoFile(f);
  });
});
</script>
<script>
(function initPositionGrid(){
  const grid   = document.querySelector('.pos-grid');
  const hidden = document.getElementById('positionInput');
  if (!grid || !hidden) return;

  // Click to select (ignores disabled cells)
  grid.addEventListener('click', (e) => {
    const btn = e.target.closest('.pos-cell[data-pos]:not(.pos-disabled)');
    if (!btn || !grid.contains(btn)) return;

    // update active state
    grid.querySelectorAll('.pos-cell[data-pos].active')
        .forEach(el => el.classList.remove('active'));
    btn.classList.add('active');

    // update hidden field for backend
    hidden.value = btn.dataset.pos || 'center';
  });

  // Keyboard support
  grid.addEventListener('keydown', (e) => {
    if ((e.key === 'Enter' || e.key === ' ') &&
        e.target.matches('.pos-cell[data-pos]:not(.pos-disabled)')) {
      e.preventDefault();
      e.target.click();
    }
  });

  // Ensure initial state matches hidden input on load
  const current = hidden.value || 'center';
  const currentBtn = grid.querySelector(`.pos-cell[data-pos="${current}"]`);
  if (currentBtn) {
    grid.querySelectorAll('.pos-cell[data-pos].active')
        .forEach(el => el.classList.remove('active'));
    currentBtn.classList.add('active');
  }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form        = document.getElementById('wmForm');
  if (!form) return;

  const loadingEl   = form.querySelector('#statusLoading');
  const successEl   = form.querySelector('#statusSuccess');
  const errorEl     = document.getElementById('statusErrorGlobal') || form.querySelector('#statusError');
  const downloadEl  = form.querySelector('#downloadLink');
  const outNameEl   = form.querySelector('#outName');
  const submitBtn   = form.querySelector('#submitBtn');
  const logoInput   = form.querySelector('#logoInput');
  const wmTextInput = form.querySelector('#wmText');
  const wmReqMsg    = form.querySelector('#wmReqMsg');

  const hasLogo = () => logoInput?.files?.length > 0;
  const hasText = () => !!wmTextInput?.value.trim();

  let triedSubmit = false;

  // ---- small helpers ----
  function show(el){ if(!el) return; el.classList.remove('d-none'); el.removeAttribute('hidden'); el.style.display=''; }
  function hide(el){ if(!el) return; el.classList.add('d-none'); el.setAttribute('hidden',''); el.style.display='none'; }
  function setLoading(on){
    if(on){ hide(successEl); hide(errorEl); show(loadingEl); loadingEl && loadingEl.offsetHeight; }
    else{ hide(loadingEl); }
    if(submitBtn) submitBtn.disabled = on;
  }
  function validateReq(){
    if (!triedSubmit) return;
    const ok = hasLogo() || hasText();
    if (wmReqMsg) wmReqMsg.classList.toggle('d-none', ok);
  }
  wmTextInput?.addEventListener('input', validateReq);
  logoInput?.addEventListener('change', validateReq);

  // ---- inline preview container (auto-create if missing) ----
  function ensureInlinePreview(){
    let wrap = document.getElementById('inlineResult');
    if (wrap) return wrap;

    wrap = document.createElement('div');
    wrap.id = 'inlineResult';
    wrap.className = 'mt-3 d-none';
    wrap.innerHTML = `
      <figure class="m-0">
        <img id="resultImg" class="img-fluid rounded shadow-sm d-none" alt="Watermarked result"/>
        <video id="resultVideo" class="w-100 rounded shadow-sm d-none" playsinline controls></video>
        <figcaption class="small text-muted mt-2">
          Long-press to save. 
          <a id="openInNewTab" class="ms-2 d-none" target="_blank" rel="noopener">Open in new tab</a>
          <a id="downloadInline" class="ms-2 d-none" download>Download</a>
        </figcaption>
      </figure>`;
    (successEl?.after ? successEl.after(wrap) : form.appendChild(wrap));
    return wrap;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const ok = hasLogo() || hasText();
    if (!ok){
      triedSubmit = true;
      wmReqMsg && wmReqMsg.classList.remove('d-none');
      wmTextInput?.focus();
      return;
    }

    setLoading(true);
    try {
      // Build FormData
      let fd = new FormData(form);

      // If targeting /upload (single-file endpoint), remap 'files' -> 'file' (first item)
      const action = form.action || '/upload-multi';
      if (action.endsWith('/upload')) {
        const files = fd.getAll('files');
        fd.delete('files');
        if (files && files.length > 0) {
          fd.append('file', files[0]);
        }
      }

      const res = await fetch(action, { method: 'POST', body: fd });
      if (!res.ok){
        const txt = await res.text().catch(()=> '');
        throw new Error(txt || `Upload failed (${res.status})`);
      }

      const blob = await res.blob();
      const ct = (res.headers.get('Content-Type') || '').toLowerCase();

      // Extract filename if present
      const cd = res.headers.get('Content-Disposition') || '';
      let filename = '';
      let m = cd.match(/filename\*=UTF-8''([^;]+)/i);
      if (m && m[1]) { try { filename = decodeURIComponent(m[1]); } catch { filename = m[1]; } }
      else {
        m = cd.match(/filename="([^"]+)"/i);
        if (m && m[1]) filename = m[1];
      }
      if (!filename) {
        if (ct.includes('zip')) filename = 'watermarked.zip';
        else if (ct.includes('mp4') || ct.includes('video/')) filename = 'watermarked.mp4';
        else if (ct.includes('png')) filename = 'watermarked.png';
        else if (ct.includes('jpeg') || ct.includes('jpg')) filename = 'watermarked.jpg';
        else filename = action.endsWith('/upload-multi') ? 'watermarked.zip' : 'watermarked.bin';
      }

      const url = URL.createObjectURL(blob);

      // Always wire download link
      if (downloadEl) { downloadEl.href = url; downloadEl.download = filename; }
      if (outNameEl)  { outNameEl.textContent = filename; }

      // Inline preview for single-file endpoint
      const isSingle   = action.endsWith('/upload');
      const inlineWrap = ensureInlinePreview();
      const resultImg   = inlineWrap.querySelector('#resultImg');
      const resultVideo = inlineWrap.querySelector('#resultVideo');
      const openInNew   = inlineWrap.querySelector('#openInNewTab');
      const downloadInline = inlineWrap.querySelector('#downloadInline'); // NEW

      // reset
      resultImg.classList.add('d-none');
      resultVideo.classList.add('d-none');
      openInNew.classList.add('d-none');
      if (downloadInline) downloadInline.classList.add('d-none'); // NEW

      if (isSingle) {
        if (ct.startsWith('image/')) {
          // IMAGE: inline preview, no success alert
          resultImg.src = url;
          resultImg.alt = filename || 'Watermarked image';
          resultImg.classList.remove('d-none');
          inlineWrap.classList.remove('d-none');
          if (openInNew) { openInNew.href = url; openInNew.textContent = 'Open image'; openInNew.classList.remove('d-none'); }
          hide(successEl);
        } else if (ct.startsWith('video/')) {
          // VIDEO: inline + download links + success alert
          resultVideo.src = url;
          resultVideo.classList.remove('d-none');
          inlineWrap.classList.remove('d-none');

          if (openInNew) {
            openInNew.href = url;
            openInNew.textContent = 'Open video';
            openInNew.classList.remove('d-none');
          }
          if (downloadInline) {
            downloadInline.href = url;
            downloadInline.download = filename || 'watermarked.mp4';
            downloadInline.textContent = 'Download';
            downloadInline.setAttribute('aria-label', 'Download video'); // a11y
            downloadInline.classList.remove('d-none');                   // <-- SHOW
          }

          show(successEl); // keep global green Download link visible too
        } else {
          show(successEl);
        }
      } else {
        show(successEl);
      }

      setLoading(false);
    } catch (err){
      setLoading(false);
      if (errorEl){
        errorEl.textContent = err?.message || 'Something went wrong.';
        show(errorEl);
      }
    }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('opacityInput');
  const out   = document.getElementById('opacityValue');
  if (!input || !out) return;

  const clamp = v => Math.max(0, Math.min(1, parseFloat(v || 0)));

  function fmt(v){
    let x = clamp(v);
    // snap near the edges to avoid floating-point weirdness
    if (x < 1e-9) x = 0;
    if (1 - x < 1e-9) x = 1;
    return (x === 0 || x === 1) ? String(x) : x.toFixed(2);
  }

  const update = () => { out.textContent = fmt(input.value); };

  input.addEventListener('input',  update);
  input.addEventListener('change', update);
  input.form?.addEventListener('reset', () => setTimeout(update, 0));
  update();
});
</script>
<script>
(function initPositionGridAndValue(){
  const grid    = document.querySelector('.pos-grid');
  const hidden  = document.getElementById('positionInput');
  const display = document.getElementById('positionValue');
  if (!grid || !hidden) return;

  const human = { tl: 'Top left', tr: 'Top right', bl: 'Bottom left', br: 'Bottom right', center: 'Center' };
  const setDisplay = (val) => { if (display) display.textContent = human[val] || val || 'center'; };

  // set initial active state + label
  const current = hidden.value || 'center';
  grid.querySelectorAll('.pos-cell[data-pos].active').forEach(el => el.classList.remove('active'));
  grid.querySelector(`.pos-cell[data-pos="${current}"]`)?.classList.add('active');
  setDisplay(current);

  // click to change
  grid.addEventListener('click', (e) => {
    const btn = e.target.closest('.pos-cell[data-pos]:not(.pos-disabled)');
    if (!btn) return;

    grid.querySelectorAll('.pos-cell[data-pos].active').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');

    const val = btn.dataset.pos || 'center';
    hidden.value = val;
    setDisplay(val);
  });

  // keyboard support
  grid.addEventListener('keydown', (e) => {
    if ((e.key === 'Enter' || e.key === ' ') &&
        e.target.matches('.pos-cell[data-pos]:not(.pos-disabled)')) {
      e.preventDefault();
      e.target.click();
    }
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const input  = document.getElementById('scaleInput');
  const chip   = document.getElementById('scaleValue');
  if (!input || !chip) return;

  const min = parseFloat(input.min || '0.2');
  const max = parseFloat(input.max || '0.8');

  // Desired casing:
  const labels = ['Very small', 'Small', 'Medium', 'Large', 'Very large'];

  const clamp01 = x => Math.max(0, Math.min(1, x));
  const norm = v => clamp01((parseFloat(v) - min) / (max - min));

  function bucketLabel(t){
    const idx = Math.round(t * (labels.length - 1));
    return labels[idx];
  }

  function update(){
    const t = norm(input.value);
    chip.textContent = bucketLabel(t);
    chip.style.setProperty('--p', t.toString());
  }

  input.addEventListener('input', update);
  input.addEventListener('change', update);
  input.form?.addEventListener('reset', () => setTimeout(update, 0));
  update();
});
</script>
{% endblock %}