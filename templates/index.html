{% extends "base.html" %}
{% block title %}Upload | Fast Watermarker{% endblock %}

{% block content %}
  <form id="wmForm" action="/upload-multi" method="post" enctype="multipart/form-data" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label">Media file(s)</label>
      <input id="fileInput" class="form-control" type="file" name="files" accept="image/*,video/*" multiple required>
      <div id="previewContainer" class="row row-cols-2 row-cols-md-3 g-2 mt-2"></div>
    </div>

    <hr class="my-4">

    <div class="mb-3">
      <label class="form-label">Logo watermark</label>
      <input id="logoInput" class="form-control" type="file" name="logo" accept="image/png,image/*">
      <div id="logoPreviewContainer" class="mt-2"></div>
    </div>

    <div class="d-flex justify-content-center align-items-center my-3">
      <span class="text-muted">OR</span>
    </div>

    <div class="mb-3">
      <label class="form-label">Text watermark</label>
      <input id="wmText" class="form-control" type="text" name="text" placeholder="© mybrand">
      <small id="wmReqMsg" class="text-danger d-none">Add a logo or enter text to continue.</small>
    </div>
    <hr class="my-4">
    <div class="mb-3">
      <label class="form-label">Watermark size</label>
      <input class="form-range"
            type="range"
            min="0.20" max="0.80" step="0.05"
            name="scale" value="0.35">
    </div>
    <div class="mb-3">
      <label class="form-label d-flex align-items-center justify-content-between">
        <span>Watermark opacity</span>
      </label>
      <input class="form-range"
            type="range"
            min="0.10" max="1.00" step="0.05"
            name="opacity" id="opacityInput" value="0.90">
    </div>
    <div class="mb-3">
      <label class="form-label d-block">Watermark position</label>

      <!-- hidden that actually gets submitted -->
      <input type="hidden" name="position" id="positionInput" value="center">

      <!-- 3x3 grid, we only enable the four corners + center -->
      <div class="pos-grid" role="group" aria-label="Watermark position">
        <button type="button" class="pos-cell" data-pos="tl" aria-label="Top left"></button>
        <button type="button" class="pos-cell pos-disabled"></button>
        <button type="button" class="pos-cell" data-pos="tr" aria-label="Top right"></button>

        <button type="button" class="pos-cell pos-disabled"></button>
        <button type="button" class="pos-cell active" data-pos="center" aria-label="Center"></button>
        <button type="button" class="pos-cell pos-disabled"></button>

        <button type="button" class="pos-cell" data-pos="bl" aria-label="Bottom left"></button>
        <button type="button" class="pos-cell pos-disabled"></button>
        <button type="button" class="pos-cell" data-pos="br" aria-label="Bottom right"></button>
    </div>
    <hr class="my-4">
    </div>
    <button id="submitBtn" class="btn btn-primary" type="submit">Upload</button>
    <div id="statusLoading" class="alert alert-info d-none mt-3 mb-0">
      <div class="d-flex align-items-center gap-2">
        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        <span>Processing your files...</span>
      </div>
    </div>
    <div id="statusSuccess" class="alert alert-success d-none mt-3 mb-0">
      Done! <strong id="outName">watermarked.zip</strong>
      <a id="downloadLink" class="ms-2" style="color: green" download>Download</a>
    </div>
    <div id="statusError" class="alert alert-danger d-none mt-3 mb-0"></div>
  </form>

  <style>
    .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
    }
    .remove-btn:hover {
      background: rgba(255, 0, 0, 0.8);
    }
    .preview-wrapper {
      position: relative;
    }
  </style>

  <script>
    const form       = document.getElementById('wmForm');
    const fileInput  = document.getElementById('fileInput');
    const logoInput  = document.getElementById('logoInput');
    const submitBtn  = document.getElementById('submitBtn');

    const loadingEl  = document.getElementById('statusLoading');
    const successEl  = document.getElementById('statusSuccess');
    const errorEl    = document.getElementById('statusError');
    const downloadLink = document.getElementById('downloadLink');
    const outNameEl    = document.getElementById('outName');

    const MAX_IMAGE_MB = 25;
    const MAX_VIDEO_MB = 300;

    const wmText   = document.getElementById('wmText');
    const wmReqMsg = document.getElementById('wmReqMsg');

    // Show message only AFTER the user tries to submit once
    let triedSubmit = false;

    function hasLogo() { return logoInput?.files?.length > 0; }
    function hasText() { return wmText?.value.trim().length > 0; }

    function showRequirementIfNeeded() {
      if (!triedSubmit) return;          // don’t show on page load
      const ok = hasLogo() || hasText();
      wmReqMsg?.classList.toggle('d-none', ok);
    }

    // While typing/choosing, auto-hide the message AFTER a failed attempt
    wmText?.addEventListener('input', showRequirementIfNeeded);
    logoInput?.addEventListener('change', showRequirementIfNeeded);

    // Position grid -> hidden input
    (() => {
      const grid = document.querySelector('.pos-grid');
      const hidden = document.getElementById('positionInput');
      if (!grid || !hidden) return;
      grid.addEventListener('click', (e) => {
        const btn = e.target.closest('.pos-cell[data-pos]');
        if (!btn) return;
        grid.querySelectorAll('.pos-cell').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        hidden.value = btn.getAttribute('data-pos'); // tl|tr|center|bl|br
      });
    })();

    // Build previews
    fileInput.addEventListener('change', () => {
      const container = document.getElementById('previewContainer');
      container.innerHTML = '';
      const files = fileInput.files || [];

      if (files.length > 20) {
        alert("You can only upload up to 20 files at once.");
        fileInput.value = "";
        return;
      }

      Array.from(files).forEach((f, index) => {
        const mb = f.size / (1024 * 1024);
        const isVideo = /^video\//.test(f.type);
        const limit = isVideo ? MAX_VIDEO_MB : MAX_IMAGE_MB;
        if (mb > limit) throw new Error(`${f.name} exceeds ${limit} MB.`);

        const col = document.createElement('div');
        col.className = 'col';

        const card = document.createElement('div');
        card.className = 'card h-100';

        const wrapper = document.createElement('div');
        wrapper.className = 'preview-wrapper';

        const url = URL.createObjectURL(f);

        if (isVideo) {
          // Shell for centered play button + snapshot
          const shell = document.createElement('div');
          shell.className = 'video-thumb';

          // Visible image filled from first decoded frame
          const img = document.createElement('img');
          img.className = 'thumb-img card-img-top';
          img.alt = f.name;
          shell.appendChild(img);

          // Hidden video used to extract a frame, then for playback when clicked
          const video = document.createElement('video');
          video.src = url;
          video.preload = 'metadata';
          video.playsInline = true;
          video.setAttribute('playsinline', '');
          video.muted = true;
          video.controls = false;
          video.style.display = 'none';
          video.className = 'card-img-top';
          shell.appendChild(video);

          // Centered play overlay
          const overlay = document.createElement('button');
          overlay.type = 'button';
          overlay.className = 'play-overlay';
          overlay.innerHTML = `
            <svg viewBox="0 0 54 54" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="27" cy="27" r="26" fill="rgba(0,0,0,.55)" stroke="white" stroke-width="2"/>
              <polygon points="22,17 22,37 38,27" fill="white"/>
            </svg>`;
          shell.appendChild(overlay);

          // Draw decoded frame into the <img>
          function drawThumb() {
            const w = video.videoWidth, h = video.videoHeight;
            if (!w || !h) return;
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            try {
              ctx.drawImage(video, 0, 0, w, h);
              img.src = canvas.toDataURL('image/jpeg', 0.72);
            } catch {}
          }

          function makeThumbAfterSeek() {
            if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
              video.requestVideoFrameCallback(() => { drawThumb(); });
            } else {
              const onSeeked = () => {
                video.removeEventListener('seeked', onSeeked);
                if (video.readyState >= 2) drawThumb();
                else setTimeout(drawThumb, 50);
              };
              video.addEventListener('seeked', onSeeked);
            }
          }

          video.addEventListener('loadedmetadata', () => {
            const t = Math.min(0.1, (video.duration || 1) - 0.001);
            makeThumbAfterSeek();
            try { video.currentTime = t; }
            catch { setTimeout(() => { try { video.currentTime = t; } catch {} }, 30); }
          }, { once: true });

          overlay.addEventListener('click', () => {
            overlay.remove();
            img.style.display = 'none';
            video.style.display = '';
            video.controls = true;
            video.muted = false; // optional
            video.play().catch(() => {});
          });

          wrapper.appendChild(shell);

          // Revoke URL when card removed
          wrapper.addEventListener('DOMNodeRemoved', () => URL.revokeObjectURL(url), { once: true });

        } else {
          const img = document.createElement('img');
          img.alt = f.name;
          img.className = 'card-img-top';
          img.style.height = '140px';
          img.style.objectFit = 'cover';
          img.src = url;
          img.onload = () => URL.revokeObjectURL(url);
          wrapper.appendChild(img);
        }

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.title = 'Remove file';
        removeBtn.addEventListener('click', () => {
          const dt = new DataTransfer();
          Array.from(fileInput.files).forEach((file, i) => { if (i !== index) dt.items.add(file); });
          fileInput.files = dt.files;
          fileInput.dispatchEvent(new Event('change'));
        });
        wrapper.appendChild(removeBtn);

        // Caption
        const cap = document.createElement('div');
        cap.className = 'card-body py-2';
        cap.innerHTML = `<small class="text-truncate d-block">${f.name}</small>`;

        card.appendChild(wrapper);
        card.appendChild(cap);
        col.appendChild(card);
        container.appendChild(col);
      });
    });

    // Logo preview
    logoInput.addEventListener('change', () => {
      const container = document.getElementById('logoPreviewContainer');
      container.innerHTML = '';
      const file = logoInput.files?.[0];
      if (!file) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'preview-wrapper';

      const img = document.createElement('img');
      img.alt = 'Logo preview';
      img.className = 'img-thumbnail mt-2';
      img.style.maxHeight = '120px';
      const url = URL.createObjectURL(file);
      img.src = url;
      img.onload = () => URL.revokeObjectURL(url);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.innerHTML = '×';
      removeBtn.title = 'Remove logo';
      removeBtn.addEventListener('click', () => {
        logoInput.value = '';
        container.innerHTML = '';
      });

      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      container.appendChild(wrapper);
    });

    // Submit
    function show(el){ el.classList.remove('d-none'); }
    function hide(el){ el.classList.add('d-none'); }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const ok = hasLogo() || hasText();
      if (!ok) {
        triedSubmit = true;
        wmReqMsg?.classList.remove('d-none');  // show only now
        wmText?.focus();
        return;
      }

      const show = (el) => el.classList.remove('d-none');
      const hide = (el) => el.classList.add('d-none');

      hide(successEl);
      hide(errorEl);
      show(loadingEl);
      submitBtn.disabled = true;

      try {
        const fd = new FormData(form);
        const res = await fetch(form.action || '/upload-multi', { method: 'POST', body: fd });
        if (!res.ok) {
          const txt = await res.text().catch(() => '');
          throw new Error(txt || `Upload failed with status ${res.status}`);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = 'watermarked.zip';
        outNameEl.textContent = 'watermarked.zip';

        hide(loadingEl);
        show(successEl);
      } catch (err) {
        hide(loadingEl);
        errorEl.textContent = err?.message || 'Something went wrong.';
        show(errorEl);
      } finally {
        submitBtn.disabled = false;
      }
    });

  </script>
{% endblock %}