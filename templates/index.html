{% extends "base.html" %}
{% block title %}Upload | Fast Watermarker{% endblock %}

{% block content %}
  <h1 class="mb-4">Fast Watermarker® - Watermark your images easily</h1>

  <form id="wmForm" action="/upload-multi" method="post" enctype="multipart/form-data" class="card p-4 shadow-sm">
    <div class="mb-3">
      <label class="form-label">Image file(s)</label>
      <input id="fileInput" class="form-control" type="file" name="files" accept="image/*" multiple required>
      <div id="previewContainer" class="row row-cols-2 row-cols-md-3 g-2 mt-2"></div>
    </div>

    <hr class="my-4">

    <div class="mb-3">
      <label class="form-label">Logo watermark</label>
      <input id="logoInput" class="form-control" type="file" name="logo" accept="image/png,image/*">
      <div id="logoPreviewContainer" class="mt-2"></div>
    </div>

    <div class="mb-3">
      <label class="form-label">Logo scale</label>
      <input class="form-range" type="range" min="0.35" max="0.7" step="0.05" name="logo_scale" value="0.5">
    </div>

    <div class="d-flex justify-content-center align-items-center my-3">
      <span class="text-muted">OR</span>
    </div>

    <div class="mb-3">
      <label class="form-label">Watermark text</label>
      <input id="wmText" class="form-control" type="text" name="text" placeholder="© mybrand">
    </div>
    <hr class="my-4">
    <button id="submitBtn" class="btn btn-primary" type="submit">Upload</button>
    <div id="statusLoading" class="alert alert-info d-none mt-3 mb-0">
      <div class="d-flex align-items-center gap-2">
        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        <span>Processing your images…</span>
      </div>
    </div>
    <div id="statusSuccess" class="alert alert-success d-none mt-3 mb-0">
      Done! <strong id="outName">watermarked.zip</strong>
      <a id="downloadLink" class="ms-2" style="color: green" download>Download</a>
    </div>
    <div id="statusError" class="alert alert-danger d-none mt-3 mb-0"></div>
  </form>

  <script>
    const form = document.getElementById('wmForm');
    const fileInput = document.getElementById('fileInput');
    const submitBtn = document.getElementById('submitBtn');
    const logoInput = document.getElementById('logoInput');

    const loadingEl = document.getElementById('statusLoading');
    const successEl = document.getElementById('statusSuccess');
    const errorEl = document.getElementById('statusError');
    const downloadLink = document.getElementById('downloadLink');
    const outNameEl = document.getElementById('outName');

    fileInput.addEventListener('change', () => {
      const container = document.getElementById('previewContainer');
      container.innerHTML = '';
      const files = fileInput.files || [];

      if (files.length > 20) {
        alert("You can only upload up to 20 images at once.");
        fileInput.value = "";
        return;
      }

      [...files].forEach(f => {
        const col = document.createElement('div');
        col.className = 'col';
        const card = document.createElement('div');
        card.className = 'card h-100';
        const img = document.createElement('img');
        img.alt = f.name;
        img.className = 'card-img-top';
        img.style.maxHeight = '140px';
        img.style.objectFit = 'cover';
        const url = URL.createObjectURL(f);
        img.src = url;
        img.onload = () => URL.revokeObjectURL(url);

        const cap = document.createElement('div');
        cap.className = 'card-body py-2';
        cap.innerHTML = `<small class="text-truncate d-block">${f.name}</small>`;

        card.appendChild(img);
        card.appendChild(cap);
        col.appendChild(card);
        container.appendChild(col);
      });
    });

    logoInput.addEventListener('change', () => {
      const container = document.getElementById('logoPreviewContainer');
      container.innerHTML = '';
      const file = logoInput.files?.[0];
      if (!file) return;
      const img = document.createElement('img');
      img.alt = 'Logo preview';
      img.className = 'img-thumbnail mt-2';
      img.style.maxHeight = '120px';
      img.src = URL.createObjectURL(file);
      container.appendChild(img);
    });

    function show(el) { el.classList.remove('d-none'); }
    function hide(el) { el.classList.add('d-none'); }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      hide(successEl);
      hide(errorEl);
      show(loadingEl);
      submitBtn.disabled = true;

      try {
        const fd = new FormData(form);
        const res = await fetch(form.action || '/upload-multi', { method: 'POST', body: fd });
        if (!res.ok) {
          const txt = await res.text().catch(() => '');
          throw new Error(txt || `Upload failed with status ${res.status}`);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = 'watermarked.zip';
        outNameEl.textContent = 'watermarked.zip';

        hide(loadingEl); show(successEl);
      } catch (err) {
        hide(loadingEl);
        errorEl.textContent = err?.message || 'Something went wrong.';
        show(errorEl);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
{% endblock %}